<!--
種別: decisions
対象: YOLOv8学習戦略
作成日: 2026-02-26
更新日: 2026-02-26
担当: AIエージェント
-->

# YOLOv8 学習戦略

## 概要

指サック検出用の YOLOv8 モデルの学習方針を決定する。モデルサイズ、データ拡張、評価指標、学習パラメータ、および精度が不足した場合の改善方針を定める。

## 設計判断

### 判断1: モデルサイズ — YOLOv8n (nano)

**問題**: YOLOv8 のどのサイズバリアントを使用するか

**選択肢**:

1. YOLOv8n (nano) — 3.2M params, 推論 ~1-2ms (GPU) / ~10-20ms (CPU)
2. YOLOv8s (small) — 11.2M params, 推論 ~2-4ms (GPU) / ~30-50ms (CPU)
3. YOLOv8m (medium) — 25.9M params

**決定**: 選択肢1 — YOLOv8n (nano)

**理由**:

- 検出対象が鮮やかな色の指サック 2 クラスのみであり、nano の表現力で十分
- リアルタイム計測のため推論速度を最優先する
- CPU 環境でも 10-20ms で推論可能（RealSense の 30fps に十分間に合う）

**トレードオフ**:

- **利点**: 最速の推論速度、軽量で Linux PC の負荷が低い
- **欠点**: 複雑な背景や遮蔽がある場合に精度が落ちる可能性（不足なら small にスケールアップ）

### 判断2: データ拡張 — Roboflow のエクスポート時拡張

**問題**: 学習データの拡張をどこで行うか

**選択肢**:

1. Roboflow のエクスポート時に拡張を適用
2. ultralytics の学習時デフォルト augmentation（mosaic, mixup 等）のみ
3. Roboflow + ultralytics の両方を併用

**決定**: 選択肢1 — Roboflow のエクスポート時拡張

**理由**:

- Roboflow の UI で拡張内容（回転・反転・明度変更・ノイズ追加等）をプレビューしながら設定できる
- エクスポート時に拡張済みデータセットを生成するため、学習スクリプト側の設定が不要
- 300 枚 → 拡張で数倍に増やすことで、nano モデルの学習に十分なデータ量を確保
- ultralytics の mosaic 等は Roboflow 拡張と重複する可能性があるため、学習時は `augment=False` または最小限に設定

**トレードオフ**:

- **利点**: 拡張結果を事前確認可能、学習の再現性が高い（拡張済みデータが固定）
- **欠点**: データセットのストレージが増加（拡張分のファイル）、拡張パターン変更時に再エクスポートが必要

**適用する拡張**:

| 拡張 | 設定 | 理由 |
|------|------|------|
| 水平反転 | 50% | 左右の手に対応 |
| 回転 | ±15° | 手の傾きのバリエーション |
| 明度調整 | ±20% | 照明条件の変化 |
| ぼかし | 最大 1.5px | カメラの焦点ずれ |

### 判断3: 評価指標 — mAP50 重視

**問題**: モデルの品質をどの指標で判断するか

**選択肢**:

1. mAP50（IoU >= 0.5 での平均適合率）
2. mAP50-95（IoU 0.5〜0.95 の平均）
3. Recall 重視（見落とし最小化）

**決定**: 選択肢1 — mAP50

**理由**:

- このシステムでは BB の精密さより「検出できたかどうか」が重要
- BB 内で HSV 色フィルタを掛けて正確な位置を特定するため（[ADR 002](./002-depth-measurement-logic.md) 参照）、BB が多少大きくても問題ない
- IoU 0.5 は指サックのような明確な物体には十分な閾値

**トレードオフ**:

- **利点**: 達成しやすく、後段の HSV フィルタとの組み合わせで実用上の精度が確保される
- **欠点**: BB の位置精度は保証されない（HSV フィルタで補完）

**目標値**: mAP50 >= 0.90

- 鮮やかな色の指サック 2 クラスなら達成可能な見込み
- 未達の場合はデータの追加収集・拡張パターンの見直しを実施

### 判断4: 学習パラメータ

**データ分割**: Train 70% / Val 20% / Test 10%（Roboflow で分割）

- 300 枚の場合: Train 210 / Val 60 / Test 30
- 少量データでは学習データを多めに確保する

**エポック数**: 100（上限）

- Early stopping（patience=50）で自動停止
- クラス数が 2 と少ないため、50 エポック前後で収束する可能性が高い

**学習率**: ultralytics デフォルト（lr0=0.01）

- fine-tuning なのでデフォルトから開始し、必要に応じて調整

**入力サイズ**: 640×640（YOLOv8 デフォルト）

### 判断5: 精度不足時の改善方針

mAP50 < 0.90 の場合、以下の順で改善を試みる:

1. **データ確認**: アノテーションの品質を Roboflow で再確認（誤ラベル・漏れ）
2. **データ追加**: 撮影条件のバリエーションを増やして追加収集
3. **拡張調整**: Roboflow の拡張パターンを見直し
4. **モデルスケールアップ**: YOLOv8s (small) に変更

## 関連ドキュメント

- [001-technology-stack.md](./001-technology-stack.md) — 技術スタック選定（YOLOv8-nano 採用理由）
- [002-depth-measurement-logic.md](./002-depth-measurement-logic.md) — BB 内 HSV フィルタとの連携
- [003-data-pipeline.md](./003-data-pipeline.md) — データ収集からモデル生成までのフロー
- [初期仕様書](../../archive/initial_plan.md)
