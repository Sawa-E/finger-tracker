<!--
種別: decisions
対象: RealSense深度計測ロジック
作成日: 2026-02-26
更新日: 2026-02-26
担当: AIエージェント
-->

# RealSense 深度計測ロジック

## 概要

YOLOv8 で検出した指サックの BB（バウンディングボックス）から、RealSense の深度データを用いて 3D 空間座標を取得し、指間距離を安定的に計測するためのロジックを決定する。

## 設計判断

### 判断1: 深度取得位置 — BB内HSV色フィルタ → マスク重心

**問題**: BB から指サックの代表深度値を取得する位置をどう決定するか

**選択肢**:
1. BB 中心ピクセルの深度値をそのまま使用
2. BB 中心周辺パッチ（5x5等）の中央値
3. BB 内で HSV 色フィルタ → マスク重心の深度値
4. YOLOv8-seg（セグメンテーション）→ マスク重心

**決定**: 選択肢3 — BB 内 HSV 色フィルタ → マスク重心

**理由**:
- YOLO の BB には背景ピクセルが混入する可能性がある。BB 中心が必ずしも指サック上にあるとは限らない
- BB 内に限定して HSV フィルタを掛けることで、YOLO のロバスト検出と色ベースの正確な位置特定を両立できる
- 指サックは赤・青の鮮やかな色なので、HSV フィルタの精度が高い
- YOLOv8-seg はマスクアノテーションが必要で、Roboflow でのラベリング工数が増大する

**トレードオフ**:
- **利点**: 背景混入を排除できる、BB単体やパッチ中央値より正確な代表点が得られる、追加の学習データ不要
- **欠点**: HSV 閾値のチューニングが必要（ただし BB 内に限定されるため誤検出リスクは低い）

**処理フロー**:
1. YOLO が BB を出力（`red_finger` / `blue_finger`）
2. BB 内の RGB 領域を切り出し
3. HSV 変換 → クラスに応じた色範囲でマスク生成
4. マスクの重心ピクセルを算出
5. 重心ピクセルの深度値を取得（無効なら判断3の手順へ）
6. `rs2_deproject_pixel_to_point` で 3D 座標に変換

### 判断2: 時間方向ノイズ除去 — 各指独立 3D カルマンフィルタ（等速度モデル）

**問題**: フレーム間の深度ノイズをどう平滑化し、安定した 3D 位置を得るか

**選択肢**:

追跡対象:
1. 指間距離を 1D スカラーとして直接追跡
2. 各指サックを独立した 3D カルマンフィルタで追跡し、フィルタ済み座標から距離を算出
3. 両指を結合した 12D フィルタで追跡

**決定（追跡対象）**: 選択肢2 — 各指独立 3D 追跡

**理由**:
- 片方の指サックのみ深度欠損した場合でも、もう片方は独立して追跡を継続できる
- 各指の 3D 位置をフィルタリングしてから距離を算出するため、距離値が安定する
- 1D 追跡では片方だけの欠損に対応できない。結合 12D は指間の相関モデル設計が困難で過剰

**選択肢（フィルタ方式）**:
1. 移動中央値（過去 N フレームの中央値）
2. 指数移動平均（EMA: `x_new = α * measurement + (1 - α) * x_prev`）
3. カルマンフィルタ（予測 + 観測の最適統合）

**決定（フィルタ方式）**: 選択肢3 — カルマンフィルタ

**理由**:
- 指の開閉は滑らかな運動であり、等速度モデル（位置 + 速度）で予測可能。カルマンフィルタはこの予測と RealSense の観測を統計的に最適な重みで統合する
- EMA はカルマンゲインを固定した特殊ケースと見なせる。カルマンフィルタは観測ノイズの大きさに応じてゲインを動的に調整するため、急な動きにも追従しやすい
- 深度欠損時は予測ステップのみ実行し、観測なしでも追跡を継続できる

**選択肢（運動モデル）**:
1. 等速度モデル — 状態: `[x, y, z, vx, vy, vz]` (6D)
2. 等加速度モデル — 状態: `[x, y, z, vx, vy, vz, ax, ay, az]` (9D)

**決定（運動モデル）**: 選択肢1 — 等速度モデル

**理由**:
- RealSense は 30fps で動作する。フレーム間隔 33ms では指の動きはほぼ等速に近似できる
- 加速・減速はプロセスノイズ Q がモデルの不確かさとして吸収する。追従遅れは 1〜3 フレーム（33〜100ms）程度
- 等加速度モデル（9D）は Q 行列が 9×9 になりチューニングが困難。30fps での実用上の改善は限定的

**トレードオフ**:
- **利点**: MSE 最小の理論的最適推定、予測により欠損フレームにも対応可能、応答性と安定性のバランスが良い、片方欠損時も独立追跡継続
- **欠点**: プロセスノイズ Q (6×6) と観測ノイズ R (3×3) のチューニングが必要、EMA に比べて実装がやや複雑

**構成**:

```
フィルタ1 (red_finger):
  状態: [x, y, z, vx, vy, vz]  (6D)
  観測: [x, y, z]  (rs2_deproject_pixel_to_point の出力)

フィルタ2 (blue_finger):
  状態: [x, y, z, vx, vy, vz]  (6D)
  観測: [x, y, z]  (rs2_deproject_pixel_to_point の出力)

指間距離 = ||pos1_filtered - pos2_filtered||
```

- 遷移モデル: `x' = x + vx * dt`, `vx' = vx` (+ プロセスノイズ)
- Q, R は RealSense D435i の深度ノイズ特性から初期値を設定し、実験で調整
- 参考: [カルマンフィルタの基礎解説](https://qiita.com/IshitaTakeshi/items/740ac7e9b549eee4cc04)

### 判断3: 無効深度値の対処 — BB内探索 + 直前値保持

**問題**: 深度値が 0 や欠損の場合にどう対処するか

**選択肢**:
1. 直前の有効値をそのまま保持し続ける
2. 該当フレームの計測をスキップ（表示も更新しない）
3. BB 内で有効ピクセルを探索し、見つからなければ直前有効値を一定時間保持

**決定**: 選択肢3 — BB 内探索 + 直前値保持

**理由**:
- BB 中心（またはマスク重心）が無効でも、BB 内の近傍に有効な深度ピクセルが存在することが多い
- 完全に有効ピクセルがない場合でも、直前値の短時間保持で表示の途切れを防げる
- タイムアウト（例: 0.5秒）を設けることで、指がフレームアウトした場合に古い値を使い続けることを防ぐ

**トレードオフ**:
- **利点**: 計測の途切れを最小化、一時的な深度欠損に対してロバスト
- **欠点**: 直前値保持中は実際の指位置とのズレが生じる可能性（タイムアウトで軽減）

**処理フロー**:
1. マスク内の有効深度ピクセルから中央値を取得（ノイズ耐性を優先）
2. マスク内に有効ピクセルなし → マスク重心の深度値を取得
3. マスク重心も無効 → BB 内全体で有効ピクセルを探索
4. BB 内にも有効ピクセルなし → 直前の有効値を使用（タイムアウト付き）
5. タイムアウト超過 → 「計測不能」表示

## 関連ドキュメント

- [001-technology-stack.md](./001-technology-stack.md) — 技術スタック選定
- [初期仕様書](../../archive/initial_plan.md)
