<!--
種別: decisions
対象: エラーハンドリング
作成日: 2026-02-26
更新日: 2026-02-26
担当: AIエージェント
-->

# エラーハンドリング

## 概要

finger-tracker の各モジュールで発生しうるエラー・異常状態の検出と対処方針を決定する。

## エラー分類

| 分類 | タイミング | 例 |
|------|----------|---|
| **起動時エラー** | プログラム開始時 | RealSense 未接続、モデルファイル不在、config.yaml 不在 |
| **実行中エラー** | リアルタイム処理中 | RealSense 切断、フレーム取得失敗 |
| **データエラー** | 計測処理中 | 深度欠損、未検出（ADR 002 で対処済み） |

## 設計判断

### 判断1: 起動時エラー — エラーメッセージで終了

**問題**: 必要なリソース（RealSense、モデルファイル等）が利用できない場合にどうするか

**選択肢**:

1. 明確なエラーメッセージを表示して終了
2. リソースが利用可能になるまでリトライ
3. 代替手段にフォールバック

**決定**: 選択肢1 — エラーメッセージで終了

**理由**:

- 起動時の前提条件が満たされない場合、続行しても意味のある動作ができない
- 明確なエラーメッセージと対処法を表示することで、問題解決を支援する
- リトライやフォールバックは実装の複雑さに見合わない

**トレードオフ**:

- **利点**: シンプル、問題が明確に伝わる
- **欠点**: ユーザーが手動で問題を解決して再実行する必要がある

**起動時チェック項目**:

| チェック | エラーメッセージ | 対処法の案内 |
|---------|----------------|-------------|
| RealSense 未接続 | `ERROR: RealSense D435i が見つかりません` | USB 接続を確認、`rs-enumerate-devices` で確認 |
| モデルファイル不在 | `ERROR: モデルファイルが見つかりません: {path}` | config.yaml の model.path を確認、学習を実行 |
| config.yaml 不在 | `ERROR: config.yaml が見つかりません` | プロジェクトルートに config.yaml を配置 |
| config.yaml 構文エラー | `ERROR: config.yaml の解析に失敗: {詳細}` | YAML 構文を確認 |

### 判断2: 実行中の RealSense 切断 — リトライ後に終了

**問題**: リアルタイム計測中に RealSense が切断された場合にどうするか

**選択肢**:

1. 数回リトライし、復帰しなければ計測結果を保存して終了
2. 即座に計測結果を保存して終了
3. 無期限にリトライ

**決定**: 選択肢1 — リトライ後に終了

**理由**:

- USB の一時的な接触不良で復帰する可能性がある
- 無期限リトライはプログラムがハングしたように見える
- 計測中のデータ（CSV）は終了前に必ず保存する

**トレードオフ**:

- **利点**: 一時的な切断からの自動復帰が可能、データを失わない
- **欠点**: リトライ中は計測が中断する

**リトライ仕様**:

- リトライ回数: 3回
- リトライ間隔: 1秒
- リトライ失敗時: WARNING ログを出力し、CSV を保存して終了

### 判断3: モデルファイル不在 — エラーメッセージで終了

**問題**: detection モジュール起動時に学習済みモデルが存在しない場合にどうするか

**選択肢**:

1. エラーメッセージで終了
2. YOLOv8n の事前学習済みモデル（COCO）をフォールバックとして使用

**決定**: 選択肢1 — エラーメッセージで終了

**理由**:

- COCO 事前学習済みモデルは `red_finger` / `blue_finger` クラスを検出できないため、フォールバックとして機能しない
- エラーメッセージで「学習を先に実行する」ことを案内するほうが適切

**トレードオフ**:

- **利点**: 誤動作を防止、明確なガイダンス
- **欠点**: 初回実行前に必ず学習が必要（当然の前提）

## グレースフルシャットダウン

すべての終了パス（正常終了、エラー終了、Ctrl+C）で以下を保証する:

1. CSV 計測記録のフラッシュ・クローズ
2. RealSense パイプラインの停止
3. OpenCV ウィンドウの破棄
4. ログファイルのフラッシュ

```python
# 実装方針
try:
    main_loop()
except KeyboardInterrupt:
    logger.info("ユーザーによる終了")
except Exception as e:
    logger.error(f"予期しないエラー: {e}")
finally:
    cleanup()  # CSV保存、RealSense停止、ウィンドウ破棄
```

## データエラーとの関係

深度欠損・未検出などのデータレベルのエラーは [ADR 002](./002-depth-measurement-logic.md) で対処済み:

- 深度欠損 → BB 内探索 + 直前値保持
- 未検出 → `--- mm` 表示
- カルマンフィルタ → 予測ステップのみ実行で追跡継続

これらはエラーではなく通常の動作範囲として扱う。

## 関連ドキュメント

- [002-depth-measurement-logic.md](./002-depth-measurement-logic.md) — 深度欠損・未検出時の計測ロジック
- [006-config-management.md](./006-config-management.md) — config.yaml の仕様
- [007-logging-recording.md](./007-logging-recording.md) — ログ出力・CSV 保存
- [初期仕様書](../../archive/initial_plan.md)
