<!--
種別: decisions
対象: リアルタイム表示設計
作成日: 2026-02-26
更新日: 2026-02-26
担当: AIエージェント
-->

# リアルタイム表示設計

## 概要

指間距離計測のリアルタイム表示における、ライブラリ選択・レイアウト・表示項目・FPS目標を決定する。

## RealSense D435i 動作仕様

| 項目 | 値 |
|------|-----|
| 動作範囲 | ~0.3m - 3m |
| Depth 解像度・FPS | 1280×720 @ 30fps |
| Depth 視野 | H:87° V:58° |

## 設計判断

### 判断1: 表示ライブラリ — OpenCV (cv2)

**問題**: リアルタイム映像と計測情報をどのライブラリで表示するか

**選択肢**:

1. OpenCV (cv2.imshow)
2. Matplotlib
3. Tkinter / PyQt

**決定**: 選択肢1 — OpenCV (cv2)

**理由**:

- 画像処理で既に依存しているため追加の依存関係なし
- `cv2.imshow` + `cv2.putText` でカメラ映像へのオーバーレイが最もシンプル
- 30fps のリアルタイム表示に十分なパフォーマンス

**トレードオフ**:

- **利点**: 追加依存なし、軽量、カメラ映像との統合が自然
- **欠点**: GUI ウィジェット（スライダー、ボタン等）が限定的（`cv2.createTrackbar` のみ）

### 判断2: レイアウト — シングルウィンドウ + オーバーレイ

**問題**: 表示のレイアウトをどう構成するか

**選択肢**:

1. シングルウィンドウに RGB 映像 + オーバーレイ
2. RGB ウィンドウ + 深度マップウィンドウの 2 画面

**決定**: 選択肢1 — シングルウィンドウ

**理由**:

- 1 画面で全情報を確認でき、操作が簡単
- 深度マップは常時表示の必要がない（デバッグ時のみ）
- ウィンドウ管理が不要

**トレードオフ**:

- **利点**: シンプル、1 画面完結
- **欠点**: 深度マップの可視化が標準では見られない（デバッグモードとして後から追加可能）

**レイアウト**:

```
┌────────────────────────────┐
│ FPS: 30  Conf: 0.95/0.93  │  ← 上部: ステータス情報
├────────────────────────────┤
│                            │
│    [RED]      [BLUE]       │  ← 中央: カメラ映像 + BB オーバーレイ
│      │── 45.2mm ──│       │       BB 間に距離線を描画
│                            │
│                            │
├────────────────────────────┤
│ Distance: 45.2 mm          │  ← 下部: 距離を大きく表示
└────────────────────────────┘
```

### 判断3: 表示項目

| 項目 | 表示位置 | 形式 | 備考 |
|------|---------|------|------|
| カメラ映像 + BB | 中央 | RGB 映像に BB をオーバーレイ | BB の色はクラスに対応（赤/青） |
| 指間距離 | 下部 + BB 間 | `45.2 mm` | フィルタ済み距離、小数1桁 |
| FPS | 左上 | `FPS: 30` | 実測フレームレート |
| 検出信頼度 | 上部 | `Conf: 0.95/0.93` | red/blue 各クラスの YOLO スコア |

**未検出時の表示**:

- 片方または両方が未検出の場合、距離欄に `--- mm` を表示
- 検出中の BB は通常通り描画し、未検出側の BB は非表示

### 判断4: FPS 目標 — 30fps（設定変更可能）

**問題**: リアルタイム処理のフレームレート目標をどう設定するか

**決定**: 目標 30fps。config モジュールで設定変更可能にする

**理由**:

- RealSense D435i の Depth ストリームが 1280×720 @ 30fps なので、カメラのフレームレートに合わせる
- 推論や後処理で 30fps を下回る場合は、フレームスキップではなく処理速度をボトルネックとして許容する
- config で FPS 上限を変更できるようにし、デバッグ時に低 FPS で動作確認できるようにする

**パフォーマンスバジェット（1フレーム = ~33ms）**:

| 処理 | 見込み時間 |
|------|-----------|
| RealSense フレーム取得 | ~1ms |
| YOLOv8n 推論 | ~10-20ms (CPU) |
| HSV フィルタ + 重心計算 | ~1ms |
| 深度 → 3D 変換 | ~1ms |
| カルマンフィルタ更新 | <1ms |
| OpenCV 描画 + 表示 | ~2-3ms |
| **合計** | **~15-27ms** |

CPU 環境でも 30fps 近辺は達成可能な見込み。GPU があれば余裕がある。

### 判断5: キー操作

| キー | 動作 |
|------|------|
| `q` / `ESC` | 終了 |
| `d` | デバッグ情報の表示/非表示トグル（将来拡張用） |

## 関連ドキュメント

- [001-technology-stack.md](./001-technology-stack.md) — OpenCV 採用
- [002-depth-measurement-logic.md](./002-depth-measurement-logic.md) — カルマンフィルタ・未検出時の動作
- [初期仕様書](../../archive/initial_plan.md)
